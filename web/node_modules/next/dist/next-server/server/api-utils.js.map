{"version":3,"sources":["../../../next-server/server/api-utils.ts"],"names":["apiResolver","req","res","query","resolverModule","apiContext","propagateError","apiReq","apiRes","statusCode","end","config","bodyParser","api","externalResolver","setLazyProp","getCookieParser","tryGetPreviewData","previewData","undefined","body","parseBody","sizeLimit","status","sendStatusCode","send","data","sendData","json","sendJson","redirect","statusOrUrl","url","setPreviewData","options","Object","assign","clearPreviewData","resolver","wasPiped","process","env","NODE_ENV","once","console","warn","err","ApiError","sendError","message","error","limit","contentType","headers","type","parameters","encoding","charset","buffer","e","toString","parseJson","qs","require","decode","str","length","JSON","parse","parseCookie","header","cookie","parseCookieFn","Array","isArray","join","Error","writeHead","Location","write","getHeader","Stream","setHeader","pipe","isJSONLike","includes","stringifiedBody","stringify","etag","Buffer","isBuffer","byteLength","jsonBody","COOKIE_NAME_PRERENDER_BYPASS","COOKIE_NAME_PRERENDER_DATA","SYMBOL_PREVIEW_DATA","Symbol","SYMBOL_CLEARED_COOKIES","getCookies","cookies","hasBypass","hasData","previewModeId","tokenPreviewData","jsonwebtoken","encryptedPreviewData","verify","previewModeSigningKey","decryptedPreviewData","from","previewModeEncryptionKey","defineProperty","value","enumerable","isNotValidData","payload","sign","algorithm","maxAge","expiresIn","serialize","previous","httpOnly","sameSite","secure","path","expires","Date","constructor","statusMessage","prop","getter","opts","configurable","optsReset","writable","get","set"],"mappings":"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","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { parse } from 'next/dist/compiled/content-type'\nimport { CookieSerializeOptions } from 'next/dist/compiled/cookie'\nimport getRawBody from 'raw-body'\nimport { PageConfig, PreviewData } from 'next/types'\nimport { Stream } from 'stream'\nimport { isResSent, NextApiRequest, NextApiResponse } from '../lib/utils'\nimport { decryptWithSecret, encryptWithSecret } from './crypto-utils'\nimport { interopDefault } from './load-components'\nimport { sendEtagResponse } from './send-payload'\nimport generateETag from 'etag'\n\nexport type NextApiRequestCookies = { [key: string]: string }\nexport type NextApiRequestQuery = { [key: string]: string | string[] }\n\nexport type __ApiPreviewProps = {\n  previewModeId: string\n  previewModeEncryptionKey: string\n  previewModeSigningKey: string\n}\n\nexport async function apiResolver(\n  req: IncomingMessage,\n  res: ServerResponse,\n  query: any,\n  resolverModule: any,\n  apiContext: __ApiPreviewProps,\n  propagateError: boolean\n): Promise<void> {\n  const apiReq = req as NextApiRequest\n  const apiRes = res as NextApiResponse\n\n  try {\n    if (!resolverModule) {\n      res.statusCode = 404\n      res.end('Not Found')\n      return\n    }\n    const config: PageConfig = resolverModule.config || {}\n    const bodyParser = config.api?.bodyParser !== false\n    const externalResolver = config.api?.externalResolver || false\n\n    // Parsing of cookies\n    setLazyProp({ req: apiReq }, 'cookies', getCookieParser(req))\n    // Parsing query string\n    apiReq.query = query\n    // Parsing preview data\n    setLazyProp({ req: apiReq }, 'previewData', () =>\n      tryGetPreviewData(req, res, apiContext)\n    )\n    // Checking if preview mode is enabled\n    setLazyProp({ req: apiReq }, 'preview', () =>\n      apiReq.previewData !== false ? true : undefined\n    )\n\n    // Parsing of body\n    if (bodyParser && !apiReq.body) {\n      apiReq.body = await parseBody(\n        apiReq,\n        config.api && config.api.bodyParser && config.api.bodyParser.sizeLimit\n          ? config.api.bodyParser.sizeLimit\n          : '1mb'\n      )\n    }\n\n    apiRes.status = (statusCode) => sendStatusCode(apiRes, statusCode)\n    apiRes.send = (data) => sendData(apiReq, apiRes, data)\n    apiRes.json = (data) => sendJson(apiRes, data)\n    apiRes.redirect = (statusOrUrl: number | string, url?: string) =>\n      redirect(apiRes, statusOrUrl, url)\n    apiRes.setPreviewData = (data, options = {}) =>\n      setPreviewData(apiRes, data, Object.assign({}, apiContext, options))\n    apiRes.clearPreviewData = () => clearPreviewData(apiRes)\n\n    const resolver = interopDefault(resolverModule)\n    let wasPiped = false\n\n    if (process.env.NODE_ENV !== 'production') {\n      // listen for pipe event and don't show resolve warning\n      res.once('pipe', () => (wasPiped = true))\n    }\n\n    // Call API route method\n    await resolver(req, res)\n\n    if (\n      process.env.NODE_ENV !== 'production' &&\n      !externalResolver &&\n      !isResSent(res) &&\n      !wasPiped\n    ) {\n      console.warn(\n        `API resolved without sending a response for ${req.url}, this may result in stalled requests.`\n      )\n    }\n  } catch (err) {\n    if (err instanceof ApiError) {\n      sendError(apiRes, err.statusCode, err.message)\n    } else {\n      console.error(err)\n      if (propagateError) {\n        throw err\n      }\n      sendError(apiRes, 500, 'Internal Server Error')\n    }\n  }\n}\n\n/**\n * Parse incoming message like `json` or `urlencoded`\n * @param req request object\n */\nexport async function parseBody(\n  req: NextApiRequest,\n  limit: string | number\n): Promise<any> {\n  let contentType\n  try {\n    contentType = parse(req.headers['content-type'] || 'text/plain')\n  } catch {\n    contentType = parse('text/plain')\n  }\n  const { type, parameters } = contentType\n  const encoding = parameters.charset || 'utf-8'\n\n  let buffer\n\n  try {\n    buffer = await getRawBody(req, { encoding, limit })\n  } catch (e) {\n    if (e.type === 'entity.too.large') {\n      throw new ApiError(413, `Body exceeded ${limit} limit`)\n    } else {\n      throw new ApiError(400, 'Invalid body')\n    }\n  }\n\n  const body = buffer.toString()\n\n  if (type === 'application/json' || type === 'application/ld+json') {\n    return parseJson(body)\n  } else if (type === 'application/x-www-form-urlencoded') {\n    const qs = require('querystring')\n    return qs.decode(body)\n  } else {\n    return body\n  }\n}\n\n/**\n * Parse `JSON` and handles invalid `JSON` strings\n * @param str `JSON` string\n */\nfunction parseJson(str: string): object {\n  if (str.length === 0) {\n    // special-case empty json body, as it's a common client-side mistake\n    return {}\n  }\n\n  try {\n    return JSON.parse(str)\n  } catch (e) {\n    throw new ApiError(400, 'Invalid JSON')\n  }\n}\n\n/**\n * Parse cookies from `req` header\n * @param req request object\n */\nexport function getCookieParser(\n  req: IncomingMessage\n): () => NextApiRequestCookies {\n  return function parseCookie(): NextApiRequestCookies {\n    const header: undefined | string | string[] = req.headers.cookie\n\n    if (!header) {\n      return {}\n    }\n\n    const { parse: parseCookieFn } = require('next/dist/compiled/cookie')\n    return parseCookieFn(Array.isArray(header) ? header.join(';') : header)\n  }\n}\n\n/**\n *\n * @param res response object\n * @param statusCode `HTTP` status code of response\n */\nexport function sendStatusCode(\n  res: NextApiResponse,\n  statusCode: number\n): NextApiResponse<any> {\n  res.statusCode = statusCode\n  return res\n}\n\n/**\n *\n * @param res response object\n * @param [statusOrUrl] `HTTP` status code of redirect\n * @param url URL of redirect\n */\nexport function redirect(\n  res: NextApiResponse,\n  statusOrUrl: string | number,\n  url?: string\n): NextApiResponse<any> {\n  if (typeof statusOrUrl === 'string') {\n    url = statusOrUrl\n    statusOrUrl = 307\n  }\n  if (typeof statusOrUrl !== 'number' || typeof url !== 'string') {\n    throw new Error(\n      `Invalid redirect arguments. Please use a single argument URL, e.g. res.redirect('/destination') or use a status code and URL, e.g. res.redirect(307, '/destination').`\n    )\n  }\n  res.writeHead(statusOrUrl, { Location: url })\n  res.write('')\n  res.end()\n  return res\n}\n\n/**\n * Send `any` body to response\n * @param req request object\n * @param res response object\n * @param body of response\n */\nexport function sendData(\n  req: NextApiRequest,\n  res: NextApiResponse,\n  body: any\n): void {\n  if (body === null || body === undefined) {\n    res.end()\n    return\n  }\n\n  const contentType = res.getHeader('Content-Type')\n\n  if (body instanceof Stream) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    body.pipe(res)\n    return\n  }\n\n  const isJSONLike = ['object', 'number', 'boolean'].includes(typeof body)\n  const stringifiedBody = isJSONLike ? JSON.stringify(body) : body\n  const etag = generateETag(stringifiedBody)\n  if (sendEtagResponse(req, res, etag)) {\n    return\n  }\n\n  if (Buffer.isBuffer(body)) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    res.setHeader('Content-Length', body.length)\n    res.end(body)\n    return\n  }\n\n  if (isJSONLike) {\n    res.setHeader('Content-Type', 'application/json; charset=utf-8')\n  }\n\n  res.setHeader('Content-Length', Buffer.byteLength(stringifiedBody))\n  res.end(stringifiedBody)\n}\n\n/**\n * Send `JSON` object\n * @param res response object\n * @param jsonBody of data\n */\nexport function sendJson(res: NextApiResponse, jsonBody: any): void {\n  // Set header to application/json\n  res.setHeader('Content-Type', 'application/json; charset=utf-8')\n\n  // Use send to handle request\n  res.send(jsonBody)\n}\n\nconst COOKIE_NAME_PRERENDER_BYPASS = `__prerender_bypass`\nconst COOKIE_NAME_PRERENDER_DATA = `__next_preview_data`\n\nexport const SYMBOL_PREVIEW_DATA = Symbol(COOKIE_NAME_PRERENDER_DATA)\nconst SYMBOL_CLEARED_COOKIES = Symbol(COOKIE_NAME_PRERENDER_BYPASS)\n\nexport function tryGetPreviewData(\n  req: IncomingMessage,\n  res: ServerResponse,\n  options: __ApiPreviewProps\n): PreviewData {\n  // Read cached preview data if present\n  if (SYMBOL_PREVIEW_DATA in req) {\n    return (req as any)[SYMBOL_PREVIEW_DATA] as any\n  }\n\n  const getCookies = getCookieParser(req)\n  let cookies: NextApiRequestCookies\n  try {\n    cookies = getCookies()\n  } catch {\n    // TODO: warn\n    return false\n  }\n\n  const hasBypass = COOKIE_NAME_PRERENDER_BYPASS in cookies\n  const hasData = COOKIE_NAME_PRERENDER_DATA in cookies\n\n  // Case: neither cookie is set.\n  if (!(hasBypass || hasData)) {\n    return false\n  }\n\n  // Case: one cookie is set, but not the other.\n  if (hasBypass !== hasData) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  // Case: preview session is for an old build.\n  if (cookies[COOKIE_NAME_PRERENDER_BYPASS] !== options.previewModeId) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const tokenPreviewData = cookies[COOKIE_NAME_PRERENDER_DATA]\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n  let encryptedPreviewData: {\n    data: string\n  }\n  try {\n    encryptedPreviewData = jsonwebtoken.verify(\n      tokenPreviewData,\n      options.previewModeSigningKey\n    ) as typeof encryptedPreviewData\n  } catch {\n    // TODO: warn\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const decryptedPreviewData = decryptWithSecret(\n    Buffer.from(options.previewModeEncryptionKey),\n    encryptedPreviewData.data\n  )\n\n  try {\n    // TODO: strict runtime type checking\n    const data = JSON.parse(decryptedPreviewData)\n    // Cache lookup\n    Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {\n      value: data,\n      enumerable: false,\n    })\n    return data\n  } catch {\n    return false\n  }\n}\n\nfunction isNotValidData(str: string): boolean {\n  return typeof str !== 'string' || str.length < 16\n}\n\nfunction setPreviewData<T>(\n  res: NextApiResponse<T>,\n  data: object | string, // TODO: strict runtime type checking\n  options: {\n    maxAge?: number\n  } & __ApiPreviewProps\n): NextApiResponse<T> {\n  if (isNotValidData(options.previewModeId)) {\n    throw new Error('invariant: invalid previewModeId')\n  }\n  if (isNotValidData(options.previewModeEncryptionKey)) {\n    throw new Error('invariant: invalid previewModeEncryptionKey')\n  }\n  if (isNotValidData(options.previewModeSigningKey)) {\n    throw new Error('invariant: invalid previewModeSigningKey')\n  }\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n\n  const payload = jsonwebtoken.sign(\n    {\n      data: encryptWithSecret(\n        Buffer.from(options.previewModeEncryptionKey),\n        JSON.stringify(data)\n      ),\n    },\n    options.previewModeSigningKey,\n    {\n      algorithm: 'HS256',\n      ...(options.maxAge !== undefined\n        ? { expiresIn: options.maxAge }\n        : undefined),\n    }\n  )\n\n  // limit preview mode cookie to 2KB since we shouldn't store too much\n  // data here and browsers drop cookies over 4KB\n  if (payload.length > 2048) {\n    throw new Error(\n      `Preview data is limited to 2KB currently, reduce how much data you are storing as preview data to continue`\n    )\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, options.previewModeId, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, payload, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n  ])\n  return res\n}\n\nfunction clearPreviewData<T>(res: NextApiResponse<T>): NextApiResponse<T> {\n  if (SYMBOL_CLEARED_COOKIES in res) {\n    return res\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n  ])\n\n  Object.defineProperty(res, SYMBOL_CLEARED_COOKIES, {\n    value: true,\n    enumerable: false,\n  })\n  return res\n}\n\n/**\n * Custom error class\n */\nexport class ApiError extends Error {\n  readonly statusCode: number\n\n  constructor(statusCode: number, message: string) {\n    super(message)\n    this.statusCode = statusCode\n  }\n}\n\n/**\n * Sends error in `response`\n * @param res response object\n * @param statusCode of response\n * @param message of response\n */\nexport function sendError(\n  res: NextApiResponse,\n  statusCode: number,\n  message: string\n): void {\n  res.statusCode = statusCode\n  res.statusMessage = message\n  res.end(message)\n}\n\ninterface LazyProps {\n  req: NextApiRequest\n}\n\n/**\n * Execute getter function only if its needed\n * @param LazyProps `req` and `params` for lazyProp\n * @param prop name of property\n * @param getter function to get data\n */\nexport function setLazyProp<T>(\n  { req }: LazyProps,\n  prop: string,\n  getter: () => T\n): void {\n  const opts = { configurable: true, enumerable: true }\n  const optsReset = { ...opts, writable: true }\n\n  Object.defineProperty(req, prop, {\n    ...opts,\n    get: () => {\n      const value = getter()\n      // we set the property on the object to avoid recalculating it\n      Object.defineProperty(req, prop, { ...optsReset, value })\n      return value\n    },\n    set: (value) => {\n      Object.defineProperty(req, prop, { ...optsReset, value })\n    },\n  })\n}\n"]}