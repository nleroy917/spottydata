{"version":3,"sources":["../../../../build/webpack/plugins/build-stats-plugin.ts"],"names":["STATS_VERSION","reduceSize","stats","chunks","map","chunk","reducedChunk","id","files","size","module","modules","push","reducedModule","type","moduleType","name","reasons","reason","moduleName","moduleId","entrypointName","entrypoints","assets","THRESHOLD","BufferingStream","Transform","items","itemsSize","_transform","encoding","callback","buffer","Buffer","isBuffer","from","length","concat","_flush","BuildStatsPlugin","constructor","options","distDir","apply","compiler","hooks","done","tapAsync","compilerSpan","spans","get","writeStatsSpan","traceAsyncFn","Promise","resolve","reject","statsJson","toJson","all","cached","errors","warnings","maxModules","Infinity","chunkModules","ids","fileStream","fs","createWriteStream","path","join","highWaterMark","jsonStream","bfj","streamify","version","pipe","on","err"],"mappings":"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","sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport { Transform, TransformCallback } from 'stream'\n// @ts-ignore no types package\nimport bfj from 'next/dist/compiled/bfj'\nimport { spans } from './profiling-plugin'\nimport { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { trace } from '../../../telemetry/trace'\n\nconst STATS_VERSION = 0\n\nfunction reduceSize(stats: any) {\n  stats.chunks = stats.chunks.map((chunk: any) => {\n    const reducedChunk: any = {\n      id: chunk.id,\n      files: chunk.files,\n      size: chunk.size,\n    }\n\n    for (const module of chunk.modules) {\n      if (!module.id) {\n        continue\n      }\n\n      if (!reducedChunk.modules) {\n        reducedChunk.modules = []\n      }\n\n      reducedChunk.modules.push(module.id)\n    }\n\n    return reducedChunk\n  })\n\n  stats.modules = stats.modules.map((module: any) => {\n    const reducedModule: any = {\n      type: module.type,\n      moduleType: module.moduleType,\n      size: module.size,\n      name: module.name,\n    }\n\n    if (module.reasons) {\n      for (const reason of module.reasons) {\n        if (!reason.moduleName || reason.moduleId === module.id) {\n          continue\n        }\n\n        if (!reducedModule.reasons) {\n          reducedModule.reasons = []\n        }\n\n        reducedModule.reasons.push(reason.moduleId)\n      }\n    }\n\n    return [module.id, reducedModule]\n  })\n\n  for (const entrypointName in stats.entrypoints) {\n    delete stats.entrypoints[entrypointName].assets\n  }\n\n  return stats\n}\n\nconst THRESHOLD = 16 * 1024\nclass BufferingStream extends Transform {\n  private items: Buffer[] = []\n  private itemsSize = 0\n\n  _transform(\n    chunk: Buffer | string,\n    encoding: BufferEncoding,\n    callback: TransformCallback\n  ): void {\n    const buffer = Buffer.isBuffer(chunk)\n      ? chunk\n      : Buffer.from(chunk as string, encoding)\n    const size = buffer.length\n    if (this.itemsSize > 0 && this.itemsSize + size > THRESHOLD) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n    if (size > THRESHOLD) {\n      this.push(buffer)\n    } else {\n      this.items.push(buffer)\n      this.itemsSize += size\n    }\n\n    callback()\n  }\n\n  _flush(callback: TransformCallback): void {\n    if (this.itemsSize > 0) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n\n    callback()\n  }\n}\n\n// This plugin creates a stats.json for a build when enabled\nexport default class BuildStatsPlugin {\n  private distDir: string\n\n  constructor(options: { distDir: string }) {\n    this.distDir = options.distDir\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.done.tapAsync(\n      'NextJsBuildStats',\n      async (stats, callback) => {\n        const compilerSpan = spans.get(compiler)\n        try {\n          const writeStatsSpan = trace('NextJsBuildStats', compilerSpan?.id)\n          await writeStatsSpan.traceAsyncFn(() => {\n            return new Promise((resolve, reject) => {\n              const statsJson = reduceSize(\n                stats.toJson({\n                  all: false,\n                  cached: true,\n                  reasons: true,\n                  entrypoints: true,\n                  chunks: true,\n                  errors: false,\n                  warnings: false,\n                  maxModules: Infinity,\n                  chunkModules: true,\n                  modules: true,\n                  // @ts-ignore this option exists\n                  ids: true,\n                })\n              )\n              const fileStream = fs.createWriteStream(\n                path.join(this.distDir, 'next-stats.json'),\n                { highWaterMark: THRESHOLD }\n              )\n              const jsonStream = bfj.streamify({\n                version: STATS_VERSION,\n                stats: statsJson,\n              })\n              jsonStream.pipe(new BufferingStream()).pipe(fileStream)\n              jsonStream.on('error', reject)\n              fileStream.on('error', reject)\n              jsonStream.on('dataError', reject)\n              fileStream.on('close', resolve)\n            })\n          })\n          callback()\n        } catch (err) {\n          callback(err)\n        }\n      }\n    )\n  }\n}\n"]}