{"version":3,"sources":["../../server/next-dev-server.ts"],"names":["React","Suspense","Error","ReactDevOverlayImpl","ReactDevOverlay","props","undefined","require","DevServer","Server","constructor","options","dev","devReady","setDevReady","webpackWatcher","hotReloader","isCustomServer","sortedRoutes","staticPathsWorker","_devCachedPreviewProps","renderOpts","ErrorDebug","Promise","resolve","ampSkipValidation","nextConfig","experimental","amp","skipValidation","ampValidator","html","pathname","validatorPath","validator","AmpHtmlValidator","getInstance","then","result","validateString","errors","filter","e","severity","_filterAmpDevelopmentScript","fs","existsSync","dir","console","warn","isNextDevCommand","pagesDir","Worker","maxRetries","numWorkers","cpus","forkOptions","env","process","NODE_OPTIONS","getStdout","pipe","stdout","getStderr","stderr","readBuildId","addExportPathMapRoutes","exportPathMap","log","outDir","distDir","buildId","path","page","query","router","addFsRoute","match","type","name","fn","req","res","_params","parsedUrl","urlQuery","Object","keys","key","forEach","mergedQuery","render","finished","startWatcher","regexPageExtension","RegExp","pageExtensions","join","resolved","reject","readdir","_","files","length","wp","Watchpack","watch","on","routedPages","knownFiles","getTimeInfoEntries","fileName","accuracy","test","pageName","replace","push","every","val","idx","send","devPagesManifest","dynamicRoutes","isDynamicRoute","map","setDynamicRoutes","stopWatcher","close","prepare","images","disableStaticImages","customRoutes","redirects","rewrites","headers","beforeFiles","afterFiles","fallback","Router","generateRoutes","HotReloader","config","previewProps","getPreviewProps","start","telemetry","Telemetry","record","PHASE_DEVELOPMENT_SERVER","webpackVersion","isWebpack5","cliCommand","isSrcDir","startsWith","hasNowJson","cwd","end","stop","hasPage","normalizedPath","err","error","pageFile","_beforeCatchAllRender","params","pathParts","decodedPath","decodeURIComponent","code","hasPublicFile","statusCode","renderError","servePublic","run","basePath","originalPathname","slice","publicDir","PUBLIC_DIR_MIDDLEWARE_CONFLICT","getCustomRoutes","previewModeId","crypto","randomBytes","toString","previewModeSigningKey","previewModeEncryptionKey","fsRoutes","otherRoutes","unshift","p","serveStatic","CLIENT_STATIC_FILES_PATH","DEV_CLIENT_PAGES_MANIFEST","_req","setHeader","JSON","stringify","pages","requireBasePath","generatePublicRoutes","getDynamicRoutes","event","snippetChunks","split","snippet","line","substring","col","indexOf","includes","getStaticPaths","__getStaticPaths","publicRuntimeConfig","serverRuntimeConfig","locales","defaultLocale","i18n","paths","loadStaticPaths","_isLikeServerless","staticPaths","value","fallbackMode","ensureApiPage","ensurePage","renderToHTML","compilationErr","getCompilationError","renderErrorToHTML","catch","dynamicRoute","hotReloaderError","quiet","STATIC_STATUS_PAGES","out","err2","Log","sendHTML","setImmutableAssetCacheControl","info","promises","stat","isFile","getCompilationErrors","isServeableUrl","untrustedFileUrl","decodedUntrustedFilePath","untrustedFilePath","sep"],"mappings":"4DAAA,sDACA,8CAEA,uCACA,8FACA,0EACA,0BACA,oDAEA,4DACA,4CACA,gEACA,2CACA,8CACA,mDACA,mFACA,mEACA,wDAMA,sDAOA,qFACA,4EACA,6EACA,2CACA,6CACA,yCACA,mEACA,kDACA,mCACA,4D,w4BAGA,GAAI,MAAOA,gBAAMC,QAAb,GAA0B,WAA9B,CAA2C,CACzC,KAAM,IAAIC,CAAAA,KAAJ,CACH,gOADG,CAAN,CAGD,CAED;AACA,GAAIC,CAAAA,mBAAJ,CACA,KAAMC,CAAAA,eAAe,CAAIC,KAAD,EAAgB,CACtC,GAAIF,mBAAmB,GAAKG,SAA5B,CAAuC,CACrCH,mBAAmB,CAAGI,OAAO,CAAC,oCAAD,CAAP,CACnBH,eADH,CAED,CACD,MAAOD,CAAAA,mBAAmB,CAACE,KAAD,CAA1B,CACD,CAND,CAQe,KAAMG,CAAAA,SAAN,QAAwBC,oBAAO,CAY5CC,WAAW,CACTC,OADS,CAKT,yEACA,MAAM,CAAE,GAAGA,OAAL,CAAcC,GAAG,CAAE,IAAnB,CAAN,EADA,KAhBMC,QAgBN,aAfMC,WAeN,aAdMC,cAcN,aAbMC,WAaN,aAZMC,cAYN,aAXQC,YAWR,aATQC,iBASR,aAmXMC,sBAnXN,QAEA,KAAKC,UAAL,CAAgBT,GAAhB,CAAsB,IAAtB,CACE,KAAKS,UAAN,CAAyBC,UAAzB,CAAsClB,eAAtC,CACD,KAAKS,QAAL,CAAgB,GAAIU,CAAAA,OAAJ,CAAaC,OAAD,EAAa,CACvC,KAAKV,WAAL,CAAmBU,OAAnB,CACD,CAFe,CAAhB,CAGE,KAAKH,UAAN,CAAyBI,iBAAzB,gDACC,KAAKC,UAAL,CAAgBC,YADjB,uCACC,uBAA8BC,GAD/B,eACC,uBAAmCC,cADpC,8BACsD,KADtD,CAEC,KAAKR,UAAN,CAAyBS,YAAzB,CAAwC,CACvCC,IADuC,CAEvCC,QAFuC,GAGpC,CACH,KAAMC,CAAAA,aAAa,CACjB,KAAKP,UAAL,CAAgBC,YAAhB,EACA,KAAKD,UAAL,CAAgBC,YAAhB,CAA6BC,GAD7B,EAEA,KAAKF,UAAL,CAAgBC,YAAhB,CAA6BC,GAA7B,CAAiCM,SAHnC,CAIA,MAAOC,2BAAiBC,WAAjB,CAA6BH,aAA7B,EAA4CI,IAA5C,CAAkDH,SAAD,EAAe,CACrE,KAAMI,CAAAA,MAAM,CAAGJ,SAAS,CAACK,cAAV,CAAyBR,IAAzB,CAAf,CACA,yBACEC,QADF,CAEEM,MAAM,CAACE,MAAP,CACGC,MADH,CACWC,CAAD,EAAOA,CAAC,CAACC,QAAF,GAAe,OADhC,EAEGF,MAFH,CAEWC,CAAD,EAAO,KAAKE,2BAAL,CAAiCb,IAAjC,CAAuCW,CAAvC,CAFjB,CAFF,CAKEJ,MAAM,CAACE,MAAP,CAAcC,MAAd,CAAsBC,CAAD,EAAOA,CAAC,CAACC,QAAF,GAAe,OAA3C,CALF,EAOD,CATM,CAAP,CAUD,CAlBA,CAmBD,GAAIE,YAAGC,UAAH,CAAc,eAAS,KAAKC,GAAd,CAAmB,QAAnB,CAAd,CAAJ,CAAiD,CAC/CC,OAAO,CAACC,IAAR,CACG,mIADH,EAGD,CACD,KAAKhC,cAAL,CAAsB,CAACN,OAAO,CAACuC,gBAA/B,CACA,KAAKC,QAAL,CAAgB,+BAAa,KAAKJ,GAAlB,CAAhB,CACA,KAAK5B,iBAAL,CAAyB,GAAIiC,mBAAJ,CACvB7C,OAAO,CAACiB,OAAR,CAAgB,uBAAhB,CADuB,CAEvB,CACE6B,UAAU,CAAE,CADd,CAEEC,UAAU,CAAE,KAAK5B,UAAL,CAAgBC,YAAhB,CAA6B4B,IAF3C,CAGEC,WAAW,CAAE,CACXC,GAAG,CAAE,CACH,GAAGC,OAAO,CAACD,GADR,CAEH;AACA;AACA;AACA;AACAE,YAAY,CAAE,0CANX,CADM,CAHf,CAFuB,CAAzB,CAoBA,KAAKxC,iBAAL,CAAuByC,SAAvB,GAAmCC,IAAnC,CAAwCH,OAAO,CAACI,MAAhD,EACA,KAAK3C,iBAAL,CAAuB4C,SAAvB,GAAmCF,IAAnC,CAAwCH,OAAO,CAACM,MAAhD,EACD,CAESC,WAAV,EAAgC,CAC9B,MAAO,aAAP,CACD,CAED,KAAMC,CAAAA,sBAAN,EAA+B,CAC7B;AACA;AACA,GAAI,KAAKxC,UAAL,CAAgByC,aAApB,CAAmC,CACjCnB,OAAO,CAACoB,GAAR,CAAY,oCAAZ,EACA,KAAMD,CAAAA,aAAa,CAAG,KAAM,MAAKzC,UAAL,CAAgByC,aAAhB,CAC1B,EAD0B,CAE1B,CACEvD,GAAG,CAAE,IADP,CAEEmC,GAAG,CAAE,KAAKA,GAFZ,CAGEsB,MAAM,CAAE,IAHV,CAIEC,OAAO,CAAE,KAAKA,OAJhB,CAKEC,OAAO,CAAE,KAAKA,OALhB,CAF0B,CAA5B,CASE;AACF,IAAK,KAAMC,CAAAA,IAAX,GAAmBL,CAAAA,aAAnB,CAAkC,CAChC,KAAM,CAAEM,IAAF,CAAQC,KAAK,CAAG,EAAhB,EAAuBP,aAAa,CAACK,IAAD,CAA1C,CAEA;AACA,KAAKG,MAAL,CAAYC,UAAZ,CAAuB,CACrBC,KAAK,CAAE,kBAAML,IAAN,CADc,CAErBM,IAAI,CAAE,OAFe,CAGrBC,IAAI,CAAG,GAAEP,IAAK,sBAHO,CAIrBQ,EAAE,CAAE,MAAOC,GAAP,CAAYC,GAAZ,CAAiBC,OAAjB,CAA0BC,SAA1B,GAAwC,CAC1C,KAAM,CAAEV,KAAK,CAAEW,QAAT,EAAsBD,SAA5B,CAEAE,MAAM,CAACC,IAAP,CAAYF,QAAZ,EACG5C,MADH,CACW+C,GAAD,EAASd,KAAK,CAACc,GAAD,CAAL,GAAelF,SADlC,EAEGmF,OAFH,CAEYD,GAAD,EACPxC,OAAO,CAACC,IAAR,CACG,QAAOuB,IAAK,gCAA+BgB,GAAI,oCADlD,CAHJ,EAQA,KAAME,CAAAA,WAAW,CAAG,CAAE,GAAGL,QAAL,CAAe,GAAGX,KAAlB,CAApB,CAEA,KAAM,MAAKiB,MAAL,CAAYV,GAAZ,CAAiBC,GAAjB,CAAsBT,IAAtB,CAA4BiB,WAA5B,CAAyCN,SAAzC,CAAN,CACA,MAAO,CACLQ,QAAQ,CAAE,IADL,CAAP,CAGD,CArBoB,CAAvB,EAuBD,CACF,CACF,CAED,KAAMC,CAAAA,YAAN,EAAoC,CAClC,GAAI,KAAK9E,cAAT,CAAyB,CACvB,OACD,CAED,KAAM+E,CAAAA,kBAAkB,CAAG,GAAIC,CAAAA,MAAJ,CACxB,UAAS,KAAKrE,UAAL,CAAgBsE,cAAhB,CAA+BC,IAA/B,CAAoC,GAApC,CAAyC,IAD1B,CAA3B,CAIA,GAAIC,CAAAA,QAAQ,CAAG,KAAf,CACA,MAAO,IAAI3E,CAAAA,OAAJ,CAAY,CAACC,OAAD,CAAU2E,MAAV,GAAqB,CACtC,KAAMhD,CAAAA,QAAQ,CAAG,KAAKA,QAAtB,CAEA;AACAN,YAAGuD,OAAH,CAAWjD,QAAX,CAAsB,CAACkD,CAAD,CAAIC,KAAJ,GAAc,CAClC,GAAIA,KAAJ,QAAIA,KAAK,CAAEC,MAAX,CAAmB,CACjB,OACD,CAED,GAAI,CAACL,QAAL,CAAe,CACb1E,OAAO,GACP0E,QAAQ,CAAG,IAAX,CACD,CACF,CATD,EAWA,GAAIM,CAAAA,EAAE,CAAI,KAAKzF,cAAL,CAAsB,GAAI0F,mBAAJ,EAAhC,CACAD,EAAE,CAACE,KAAH,CAAS,EAAT,CAAa,CAACvD,QAAD,CAAb,CAA0B,CAA1B,EAEAqD,EAAE,CAACG,EAAH,CAAM,YAAN,CAAoB,IAAM,CACxB,KAAMC,CAAAA,WAAW,CAAG,EAApB,CACA,KAAMC,CAAAA,UAAU,CAAGL,EAAE,CAACM,kBAAH,EAAnB,CACA,IAAK,KAAM,CAACC,QAAD,CAAW,CAAEC,QAAF,CAAX,CAAX,EAAuCH,CAAAA,UAAvC,CAAmD,CACjD,GAAIG,QAAQ,GAAK1G,SAAb,EAA0B,CAACwF,kBAAkB,CAACmB,IAAnB,CAAwBF,QAAxB,CAA/B,CAAkE,CAChE,SACD,CAED,GAAIG,CAAAA,QAAQ,CACV,IAAM,mBAAS/D,QAAT,CAAoB4D,QAApB,EAA8BI,OAA9B,CAAsC,MAAtC,CAA8C,GAA9C,CADR,CAEAD,QAAQ,CAAGA,QAAQ,CAACC,OAAT,CAAiBrB,kBAAjB,CAAqC,EAArC,CAAX,CACAoB,QAAQ,CAAGA,QAAQ,CAACC,OAAT,CAAiB,UAAjB,CAA6B,EAA7B,GAAoC,GAA/C,CAEAP,WAAW,CAACQ,IAAZ,CAAiBF,QAAjB,EACD,CAED,GAAI,wBACF;AACA;AACA;AACA,KAAMhG,CAAAA,YAAY,CAAG,2BAAgB0F,WAAhB,CAArB,CAEA,GACE,sBAAC,KAAK1F,YAAN,SAAC,mBAAmBmG,KAAnB,CAAyB,CAACC,GAAD,CAAMC,GAAN,GAAcD,GAAG,GAAKpG,YAAY,CAACqG,GAAD,CAA3D,CAAD,CADF,CAEE,CACA;AACA,KAAKvG,WAAL,CAAkBwG,IAAlB,CAAuBlH,SAAvB,CAAkC,CAAEmH,gBAAgB,CAAE,IAApB,CAAlC,EACD,CACD,KAAKvG,YAAL,CAAoBA,YAApB,CAEA,KAAKwG,aAAL,CAAqB,KAAKxG,YAAL,CAClBuB,MADkB,CACXkF,qBADW,EAElBC,GAFkB,CAEbnD,IAAD,GAAW,CACdA,IADc,CAEdI,KAAK,CAAE,2BAAgB,yBAAcJ,IAAd,CAAhB,CAFO,CAAX,CAFc,CAArB,CAOA,KAAKE,MAAL,CAAYkD,gBAAZ,CAA6B,KAAKH,aAAlC,EAEA,GAAI,CAACxB,QAAL,CAAe,CACb1E,OAAO,GACP0E,QAAQ,CAAG,IAAX,CACD,CACF,CAAC,MAAOxD,CAAP,CAAU,CACV,GAAI,CAACwD,QAAL,CAAe,CACbC,MAAM,CAACzD,CAAD,CAAN,CACAwD,QAAQ,CAAG,IAAX,CACD,CAHD,IAGO,CACLlD,OAAO,CAACC,IAAR,CAAa,kCAAb,CAAiDP,CAAjD,EACD,CACF,CACF,CAnDD,EAoDD,CAtEM,CAAP,CAuED,CAED,KAAMoF,CAAAA,WAAN,EAAmC,CACjC,GAAI,CAAC,KAAK/G,cAAV,CAA0B,CACxB,OACD,CAED,KAAKA,cAAL,CAAoBgH,KAApB,GACA,KAAKhH,cAAL,CAAsB,IAAtB,CACD,CAED,KAAMiH,CAAAA,OAAN,EAA+B,CAC7B,KAAM,iDACJ,KAAKjF,GADD,CAEJ,KAAKI,QAFD,CAGJ,KAHI,CAIJ,CAAC,KAAKzB,UAAL,CAAgBuG,MAAhB,CAAuBC,mBAJpB,CAAN,CAOA,KAAKC,YAAL,CAAoB,KAAM,8BAAiB,KAAKzG,UAAtB,CAA1B,CAEA;AACA,KAAM,CAAE0G,SAAF,CAAaC,QAAb,CAAuBC,OAAvB,EAAmC,KAAKH,YAA9C,CAEA,GACEE,QAAQ,CAACE,WAAT,CAAqBhC,MAArB,EACA8B,QAAQ,CAACG,UAAT,CAAoBjC,MADpB,EAEA8B,QAAQ,CAACI,QAAT,CAAkBlC,MAFlB,EAGA6B,SAAS,CAAC7B,MAHV,EAIA+B,OAAO,CAAC/B,MALV,CAME,CACA,KAAK5B,MAAL,CAAc,GAAI+D,gBAAJ,CAAW,KAAKC,cAAL,EAAX,CAAd,CACD,CAED,KAAK3H,WAAL,CAAmB,GAAI4H,qBAAJ,CAAgB,KAAK7F,GAArB,CAA0B,CAC3CI,QAAQ,CAAE,KAAKA,QAD4B,CAE3C0F,MAAM,CAAE,KAAKnH,UAF8B,CAG3CoH,YAAY,CAAE,KAAKC,eAAL,EAH6B,CAI3CxE,OAAO,CAAE,KAAKA,OAJ6B,CAK3C8D,QAL2C,CAA1B,CAAnB,CAOA,KAAM,OAAML,OAAN,EAAN,CACA,KAAM,MAAK9D,sBAAL,EAAN,CACA,KAAM,MAAKlD,WAAL,CAAiBgI,KAAjB,EAAN,CACA,KAAM,MAAKnD,YAAL,EAAN,CACA,KAAK/E,WAAL,GAEA,KAAMmI,CAAAA,SAAS,CAAG,GAAIC,mBAAJ,CAAc,CAAE5E,OAAO,CAAE,KAAKA,OAAhB,CAAd,CAAlB,CACA2E,SAAS,CAACE,MAAV,CACE,4BAAgBC,oCAAhB,CAA0C,KAAK9E,OAA/C,CAAwD,CACtD+E,cAAc,CAAE,KAAKrI,WAAL,CAAiBsI,UAAjB,CAA8B,CAA9B,CAAkC,CADI,CAEtDC,UAAU,CAAE,KAF0C,CAGtDC,QAAQ,CAAE,mBAAS,KAAKzG,GAAd,CAAmB,KAAKI,QAAxB,EAAmCsG,UAAnC,CAA8C,KAA9C,CAH4C,CAItDC,UAAU,CAAE,CAAC,EAAE,KAAM,oBAAO,UAAP,CAAmB,CAAEC,GAAG,CAAE,KAAK5G,GAAZ,CAAnB,CAAR,CAJyC,CAKtD9B,cAAc,CAAE,KAAKA,cALiC,CAAxD,CADF,EASA;AACA,qBAAU,WAAV,CAAuBgI,SAAvB,EACD,CAED,KAAgBlB,CAAAA,KAAhB,EAAuC,CACrC,KAAM,MAAKD,WAAL,EAAN,CACA,KAAM,MAAK3G,iBAAL,CAAuByI,GAAvB,EAAN,CACA,GAAI,KAAK5I,WAAT,CAAsB,CACpB,KAAM,MAAKA,WAAL,CAAiB6I,IAAjB,EAAN,CACD,CACF,CAED,KAAgBC,CAAAA,OAAhB,CAAwB9H,QAAxB,CAA4D,CAC1D,GAAI+H,CAAAA,cAAJ,CAEA,GAAI,CACFA,cAAc,CAAG,yCAAkB/H,QAAlB,CAAjB,CACD,CAAC,MAAOgI,GAAP,CAAY,CACZhH,OAAO,CAACiH,KAAR,CAAcD,GAAd,EACA;AACA;AACA;AACA,MAAO,MAAP,CACD,CAED,KAAME,CAAAA,QAAQ,CAAG,KAAM,+BACrB,KAAK/G,QADgB,CAErB4G,cAFqB,CAGrB,KAAKrI,UAAL,CAAgBsE,cAHK,CAAvB,CAKA,MAAO,CAAC,CAACkE,QAAT,CACD,CAED,KAAgBC,CAAAA,qBAAhB,CACElF,GADF,CAEEC,GAFF,CAGEkF,MAHF,CAIEhF,SAJF,CAKoB,CAClB,KAAM,CAAEpD,QAAF,EAAeoD,SAArB,CACA,KAAMiF,CAAAA,SAAS,CAAGD,MAAM,CAAC5F,IAAP,EAAe,EAAjC,CACA,KAAMA,CAAAA,IAAI,CAAI,IAAG6F,SAAS,CAACpE,IAAV,CAAe,GAAf,CAAoB,EAArC,CACA;AACA;AACA,GAAIqE,CAAAA,WAAJ,CAEA,GAAI,CACFA,WAAW,CAAGC,kBAAkB,CAAC/F,IAAD,CAAhC,CACD,CAAC,MAAO6B,CAAP,CAAU,CACV,KAAM2D,CAAAA,GAA8B,CAAG,GAAI9J,CAAAA,KAAJ,CAAU,wBAAV,CAAvC,CACA8J,GAAG,CAACQ,IAAJ,CAAW,eAAX,CACA,KAAMR,CAAAA,GAAN,CACD,CAED,GAAI,KAAM,MAAKS,aAAL,CAAmBH,WAAnB,CAAV,CAA2C,CACzC,GAAI,KAAM,MAAKR,OAAL,CAAa9H,QAAb,CAAV,CAAmC,CACjC,KAAMgI,CAAAA,GAAG,CAAG,GAAI9J,CAAAA,KAAJ,CACT,8DAA6D8B,QAAS,gEAD7D,CAAZ,CAGAkD,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACA,KAAM,MAAKC,WAAL,CAAiBX,GAAjB,CAAsB/E,GAAtB,CAA2BC,GAA3B,CAAgClD,QAAhC,CAA2C,EAA3C,CAAN,CACA,MAAO,KAAP,CACD,CACD,KAAM,MAAK4I,WAAL,CAAiB3F,GAAjB,CAAsBC,GAAtB,CAA2BmF,SAA3B,CAAN,CACA,MAAO,KAAP,CACD,CAED,MAAO,MAAP,CACD,CAED,KAAMQ,CAAAA,GAAN,CACE5F,GADF,CAEEC,GAFF,CAGEE,SAHF,CAIiB,yBACf,KAAM,MAAKvE,QAAX,CAEA,KAAM,CAAEiK,QAAF,EAAe,KAAKpJ,UAA1B,CACA,GAAIqJ,CAAAA,gBAA+B,CAAG,IAAtC,CAEA,GAAID,QAAQ,uBAAI1F,SAAS,CAACpD,QAAd,SAAI,oBAAoByH,UAApB,CAA+BqB,QAA/B,CAAhB,CAA0D,CACxD;AACA;AACAC,gBAAgB,CAAG3F,SAAS,CAACpD,QAA7B,CACAoD,SAAS,CAACpD,QAAV,CAAqBoD,SAAS,CAACpD,QAAV,CAAoBgJ,KAApB,CAA0BF,QAAQ,CAACvE,MAAnC,GAA8C,GAAnE,CACD,CAED,KAAM,CAAEvE,QAAF,EAAeoD,SAArB,CAEA,GAAIpD,QAAQ,CAAEyH,UAAV,CAAqB,QAArB,CAAJ,CAAoC,CAClC,GAAI,KAAM,2BAAW,eAAS,KAAKwB,SAAd,CAAyB,OAAzB,CAAX,CAAV,CAAyD,CACvD,KAAM,IAAI/K,CAAAA,KAAJ,CAAUgL,yCAAV,CAAN,CACD,CACF,CAED,KAAM,CAAEtF,QAAQ,CAAG,KAAb,EAAuB,KAAM,MAAK5E,WAAL,CAAkB6J,GAAlB,CACjC5F,GADiC,CAEjCC,GAFiC,CAGjCE,SAHiC,CAAnC,CAMA,GAAIQ,QAAJ,CAAc,CACZ,OACD,CAED,GAAImF,gBAAJ,CAAsB,CACpB;AACA;AACA3F,SAAS,CAACpD,QAAV,CAAqB+I,gBAArB,CACD,CAED,MAAO,OAAMF,GAAN,CAAU5F,GAAV,CAAeC,GAAf,CAAoBE,SAApB,CAAP,CACD,CAED;AACU+F,eAAV,EAA0C,CACxC;AACA,MAAO,CACL/C,SAAS,CAAE,EADN,CAELC,QAAQ,CAAE,CAAEE,WAAW,CAAE,EAAf,CAAmBC,UAAU,CAAE,EAA/B,CAAmCC,QAAQ,CAAE,EAA7C,CAFL,CAGLH,OAAO,CAAE,EAHJ,CAAP,CAKD,CAGSS,eAAV,EAA4B,CAC1B,GAAI,KAAK3H,sBAAT,CAAiC,CAC/B,MAAO,MAAKA,sBAAZ,CACD,CACD,MAAQ,MAAKA,sBAAL,CAA8B,CACpCgK,aAAa,CAAEC,gBAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CADqB,CAEpCC,qBAAqB,CAAEH,gBAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAFa,CAGpCE,wBAAwB,CAAEJ,gBAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAHU,CAAtC,CAKD,CAED5C,cAAc,EAAG,CACf,KAAM,CAAE+C,QAAF,CAAY,GAAGC,WAAf,EAA+B,MAAMhD,cAAN,EAArC,CAEA;AACA;AACA+C,QAAQ,CAACE,OAAT,CAAiB,CACf/G,KAAK,CAAE,kBAAM,2BAAN,CADQ,CAEfC,IAAI,CAAE,OAFS,CAGfC,IAAI,CAAE,4BAHS,CAIfC,EAAE,CAAE,MAAOC,GAAP,CAAYC,GAAZ,CAAiBkF,MAAjB,GAA4B,CAC9B,KAAMyB,CAAAA,CAAC,CAAG,eAAS,KAAKvH,OAAd,CAAuB,IAAI8F,MAAM,CAAC5F,IAAP,EAAe,EAAnB,CAAvB,CAAV,CACA,KAAM,MAAKsH,WAAL,CAAiB7G,GAAjB,CAAsBC,GAAtB,CAA2B2G,CAA3B,CAAN,CACA,MAAO,CACLjG,QAAQ,CAAE,IADL,CAAP,CAGD,CAVc,CAAjB,EAaA8F,QAAQ,CAACE,OAAT,CAAiB,CACf/G,KAAK,CAAE,kBACJ,UAASkH,oCAAyB,IAAG,KAAKxH,OAAQ,IAAGyH,qCAA0B,EAD3E,CADQ,CAIflH,IAAI,CAAE,OAJS,CAKfC,IAAI,CAAG,SAAQgH,oCAAyB,IAAG,KAAKxH,OAAQ,IAAGyH,qCAA0B,EALtE,CAMfhH,EAAE,CAAE,MAAOiH,IAAP,CAAa/G,GAAb,GAAqB,CACvBA,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACAxF,GAAG,CAACgH,SAAJ,CAAc,cAAd,CAA8B,iCAA9B,EACAhH,GAAG,CAAC0E,GAAJ,CACEuC,IAAI,CAACC,SAAL,CAAe,CACbC,KAAK,CAAE,KAAKnL,YADC,CAAf,CADF,EAKA,MAAO,CACL0E,QAAQ,CAAE,IADL,CAAP,CAGD,CAjBc,CAAjB,EAoBA8F,QAAQ,CAACtE,IAAT,CAAc,CACZvC,KAAK,CAAE,kBAAM,SAAN,CADK,CAEZC,IAAI,CAAE,OAFM,CAGZwH,eAAe,CAAE,KAHL,CAIZvH,IAAI,CAAE,iCAJM,CAKZC,EAAE,CAAE,MAAOC,GAAP,CAAYC,GAAZ,CAAiBkF,MAAjB,CAAyBhF,SAAzB,GAAuC,CACzC,KAAM,CAAEpD,QAAF,EAAeoD,SAArB,CACA,GAAI,CAACpD,QAAL,CAAe,CACb,KAAM,IAAI9B,CAAAA,KAAJ,CAAU,uBAAV,CAAN,CACD,CAED;AACA,GAAI,KAAM,MAAKiK,qBAAL,CAA2BlF,GAA3B,CAAgCC,GAAhC,CAAqCkF,MAArC,CAA6ChF,SAA7C,CAAV,CAAmE,CACjE,MAAO,CACLQ,QAAQ,CAAE,IADL,CAAP,CAGD,CAED,MAAO,CACLA,QAAQ,CAAE,KADL,CAAP,CAGD,CArBW,CAAd,EAwBA,MAAO,CAAE8F,QAAF,CAAY,GAAGC,WAAf,CAAP,CACD,CAED;AACUY,oBAAV,EAA0C,CACxC,MAAO,EAAP,CACD,CAED;AACUC,gBAAV,EAAsC,CACpC,MAAO,EAAP,CACD,CAED5J,2BAA2B,CACzBb,IADyB,CAEzB0K,KAFyB,CAGhB,CACT,GAAIA,KAAK,CAACjC,IAAN,GAAe,uBAAnB,CAA4C,CAC1C,MAAO,KAAP,CACD,CAED,KAAMkC,CAAAA,aAAa,CAAG3K,IAAI,CAAC4K,KAAL,CAAW,IAAX,CAAtB,CAEA,GAAIC,CAAAA,OAAJ,CACA,GACE,EAAEA,OAAO,CAAG7K,IAAI,CAAC4K,KAAL,CAAW,IAAX,EAAiBF,KAAK,CAACI,IAAN,CAAa,CAA9B,CAAZ,GACA,EAAED,OAAO,CAAGA,OAAO,CAACE,SAAR,CAAkBL,KAAK,CAACM,GAAxB,CAAZ,CAFF,CAGE,CACA,MAAO,KAAP,CACD,CAEDH,OAAO,CAAGA,OAAO,CAAGF,aAAa,CAAC1B,KAAd,CAAoByB,KAAK,CAACI,IAA1B,EAAgC5G,IAAhC,CAAqC,IAArC,CAApB,CACA2G,OAAO,CAAGA,OAAO,CAACE,SAAR,CAAkB,CAAlB,CAAqBF,OAAO,CAACI,OAAR,CAAgB,WAAhB,CAArB,CAAV,CAEA,MAAO,CAACJ,OAAO,CAACK,QAAR,CAAiB,gCAAjB,CAAR,CACD,CAED,KAAgBC,CAAAA,cAAhB,CACElL,QADF,CAKG,CACD;AACA;AAEA,KAAMmL,CAAAA,gBAAgB,CAAG,SAAY,CACnC,KAAM,CAAEC,mBAAF,CAAuBC,mBAAvB,EAA+C,KAAK3L,UAA1D,CACA,KAAM,CAAE4L,OAAF,CAAWC,aAAX,EAA6B,KAAK7L,UAAL,CAAgB8L,IAAhB,EAAwB,EAA3D,CAEA,KAAMC,CAAAA,KAAK,CAAG,KAAM,MAAKtM,iBAAL,CAAuBuM,eAAvB,CAClB,KAAKpJ,OADa,CAElBtC,QAFkB,CAGlB,CAAC,KAAKX,UAAL,CAAgBT,GAAjB,EAAwB,KAAK+M,iBAHX,CAIlB,CACEP,mBADF,CAEEC,mBAFF,CAJkB,CAQlBC,OARkB,CASlBC,aATkB,CAApB,CAWA,MAAOE,CAAAA,KAAP,CACD,CAhBD,CAiBA,KAAM,CAAEA,KAAK,CAAEG,WAAT,CAAsBnF,QAAtB,EAAmC,CACvC,KAAM,2CAAoB0E,gBAApB,EAAuC,eAAcnL,QAAS,EAA9D,CAAiE,EAAjE,CADiC,EAEvC6L,KAFF,CAIA,MAAO,CACLD,WADK,CAELE,YAAY,CACVrF,QAAQ,GAAK,UAAb,CACI,UADJ,CAEIA,QAAQ,GAAK,IAAb,CACA,QADA,CAEA,KAPD,CAAP,CASD,CAED,KAAgBsF,CAAAA,aAAhB,CAA8B/L,QAA9B,CAAgD,CAC9C,MAAO,MAAKhB,WAAL,CAAkBgN,UAAlB,CAA6BhM,QAA7B,CAAP,CACD,CAED,KAAMiM,CAAAA,YAAN,CACEhJ,GADF,CAEEC,GAFF,CAGElD,QAHF,CAIE0C,KAJF,CAK0B,CACxB,KAAM,MAAK7D,QAAX,CACA,KAAMqN,CAAAA,cAAc,CAAG,KAAM,MAAKC,mBAAL,CAAyBnM,QAAzB,CAA7B,CACA,GAAIkM,cAAJ,CAAoB,CAClBhJ,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACA,MAAO,MAAK0D,iBAAL,CAAuBF,cAAvB,CAAuCjJ,GAAvC,CAA4CC,GAA5C,CAAiDlD,QAAjD,CAA2D0C,KAA3D,CAAP,CACD,CAED;AACA,GAAI,CACF,KAAM,MAAK1D,WAAL,CAAkBgN,UAAlB,CAA6BhM,QAA7B,EAAuCqM,KAAvC,CAA6C,KAAOrE,CAAAA,GAAP,EAAsB,CACvE,GAAKA,GAAD,CAAaQ,IAAb,GAAsB,QAA1B,CAAoC,CAClC,KAAMR,CAAAA,GAAN,CACD,CAED,IAAK,KAAMsE,CAAAA,YAAX,GAA2B,MAAK5G,aAAL,EAAsB,EAAjD,CAAqD,CACnD,KAAM0C,CAAAA,MAAM,CAAGkE,YAAY,CAACzJ,KAAb,CAAmB7C,QAAnB,CAAf,CACA,GAAI,CAACoI,MAAL,CAAa,CACX,SACD,CAED,MAAO,MAAKpJ,WAAL,CAAkBgN,UAAlB,CAA6BM,YAAY,CAAC7J,IAA1C,CAAP,CACD,CACD,KAAMuF,CAAAA,GAAN,CACD,CAdK,CAAN,CAeD,CAAC,MAAOA,GAAP,CAAY,CACZ,GAAIA,GAAG,CAACQ,IAAJ,GAAa,QAAjB,CAA2B,CACzB,GAAI,CACF,KAAM,MAAKxJ,WAAL,CAAkBgN,UAAlB,CAA6B,MAA7B,CAAN,CACD,CAAC,MAAOO,gBAAP,CAAyB,CACzB,GAAIA,gBAAgB,CAAC/D,IAAjB,GAA0B,QAA9B,CAAwC,CACtC,KAAM+D,CAAAA,gBAAN,CACD,CACF,CAEDrJ,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACA,MAAO,MAAK0D,iBAAL,CAAuB,IAAvB,CAA6BnJ,GAA7B,CAAkCC,GAAlC,CAAuClD,QAAvC,CAAiD0C,KAAjD,CAAP,CACD,CACD,GAAI,CAAC,KAAK8J,KAAV,CAAiBxL,OAAO,CAACiH,KAAR,CAAcD,GAAd,EAClB,CACD,KAAMjI,CAAAA,IAAI,CAAG,KAAM,OAAMkM,YAAN,CAAmBhJ,GAAnB,CAAwBC,GAAxB,CAA6BlD,QAA7B,CAAuC0C,KAAvC,CAAnB,CACA,MAAO3C,CAAAA,IAAP,CACD,CAED,KAAMqM,CAAAA,iBAAN,CACEpE,GADF,CAEE/E,GAFF,CAGEC,GAHF,CAIElD,QAJF,CAKE0C,KALF,CAM0B,CACxB,KAAM,MAAK7D,QAAX,CACA,GAAIqE,GAAG,CAACwF,UAAJ,GAAmB,GAAnB,GAA2B,KAAM,MAAKZ,OAAL,CAAa,MAAb,CAAjC,CAAJ,CAA4D,CAC1D,KAAM,MAAK9I,WAAL,CAAkBgN,UAAlB,CAA6B,MAA7B,CAAN,CACD,CAFD,IAEO,IACLS,gCAAoBxB,QAApB,CAA8B,IAAG/H,GAAG,CAACwF,UAAW,EAAhD,IACC,KAAM,MAAKZ,OAAL,CAAc,IAAG5E,GAAG,CAACwF,UAAW,EAAhC,CADP,CADK,CAGL,CACA,KAAM,MAAK1J,WAAL,CAAkBgN,UAAlB,CAA8B,IAAG9I,GAAG,CAACwF,UAAW,EAAhD,CAAN,CACD,CALM,IAKA,CACL,KAAM,MAAK1J,WAAL,CAAkBgN,UAAlB,CAA6B,SAA7B,CAAN,CACD,CAED,KAAME,CAAAA,cAAc,CAAG,KAAM,MAAKC,mBAAL,CAAyBnM,QAAzB,CAA7B,CACA,GAAIkM,cAAJ,CAAoB,CAClBhJ,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACA,MAAO,OAAM0D,iBAAN,CAAwBF,cAAxB,CAAwCjJ,GAAxC,CAA6CC,GAA7C,CAAkDlD,QAAlD,CAA4D0C,KAA5D,CAAP,CACD,CAED,GAAI,CAACsF,GAAD,EAAQ9E,GAAG,CAACwF,UAAJ,GAAmB,GAA/B,CAAoC,CAClCV,GAAG,CAAG,GAAI9J,CAAAA,KAAJ,CACJ,2DACE,sDAFE,CAAN,CAID,CAED,GAAI,CACF,KAAMwO,CAAAA,GAAG,CAAG,KAAM,OAAMN,iBAAN,CAAwBpE,GAAxB,CAA6B/E,GAA7B,CAAkCC,GAAlC,CAAuClD,QAAvC,CAAiD0C,KAAjD,CAAlB,CACA,MAAOgK,CAAAA,GAAP,CACD,CAAC,MAAOC,IAAP,CAAa,CACb,GAAI,CAAC,KAAKH,KAAV,CAAiBI,GAAG,CAAC3E,KAAJ,CAAU0E,IAAV,EACjBzJ,GAAG,CAACwF,UAAJ,CAAiB,GAAjB,CACA,MAAO,OAAM0D,iBAAN,CAAwBO,IAAxB,CAA8B1J,GAA9B,CAAmCC,GAAnC,CAAwClD,QAAxC,CAAkD0C,KAAlD,CAAP,CACD,CACF,CAEDmK,QAAQ,CACN5J,GADM,CAENC,GAFM,CAGNnD,IAHM,CAIS,CACf;AACAmD,GAAG,CAACgH,SAAJ,CAAc,eAAd,CAA+B,2BAA/B,EACA,MAAO,OAAM2C,QAAN,CAAe5J,GAAf,CAAoBC,GAApB,CAAyBnD,IAAzB,CAAP,CACD,CAES+M,6BAAV,CAAwC5J,GAAxC,CAAmE,CACjEA,GAAG,CAACgH,SAAJ,CAAc,eAAd,CAA+B,2BAA/B,EACD,CAEOtB,WAAR,CACE3F,GADF,CAEEC,GAFF,CAGEmF,SAHF,CAIiB,CACf,KAAMwB,CAAAA,CAAC,CAAG,eAAS,KAAKZ,SAAd,CAAyB,GAAGZ,SAA5B,CAAV,CACA,MAAO,MAAKyB,WAAL,CAAiB7G,GAAjB,CAAsBC,GAAtB,CAA2B2G,CAA3B,CAAP,CACD,CAED,KAAMpB,CAAAA,aAAN,CAAoBjG,IAApB,CAAoD,CAClD,GAAI,CACF,KAAMuK,CAAAA,IAAI,CAAG,KAAMlM,aAAGmM,QAAH,CAAYC,IAAZ,CAAiB,eAAS,KAAKhE,SAAd,CAAyBzG,IAAzB,CAAjB,CAAnB,CACA,MAAOuK,CAAAA,IAAI,CAACG,MAAL,EAAP,CACD,CAAC,MAAO7I,CAAP,CAAU,CACV,MAAO,MAAP,CACD,CACF,CAED,KAAM8H,CAAAA,mBAAN,CAA0B1J,IAA1B,CAAsD,CACpD,KAAMjC,CAAAA,MAAM,CAAG,KAAM,MAAKxB,WAAL,CAAkBmO,oBAAlB,CAAuC1K,IAAvC,CAArB,CACA,GAAIjC,MAAM,CAAC+D,MAAP,GAAkB,CAAtB,CAAyB,OAEzB;AACA,MAAO/D,CAAAA,MAAM,CAAC,CAAD,CAAb,CACD,CAES4M,cAAV,CAAyBC,gBAAzB,CAA4D,CAC1D;AACA;AACA;AACA;AACA;AACA;AAEA,GAAIC,CAAAA,wBAAJ,CACA,GAAI,CACF;AACAA,wBAAwB,CAAG/E,kBAAkB,CAAC8E,gBAAD,CAA7C,CACD,CAAC,cAAM,CACN,MAAO,MAAP,CACD,CAED;AACA,KAAME,CAAAA,iBAAiB,CAAG,kBAAYD,wBAAZ,CAA1B,CAEA;AACA,GAAIC,iBAAiB,CAACvC,OAAlB,CAA0B,IAA1B,IAAoC,CAAC,CAAzC,CAA4C,CAC1C,MAAO,MAAP,CACD,CAED;AACA;AACA;AACA;AACA,GACEuC,iBAAiB,CAAC9F,UAAlB,CAA6B,eAAS,KAAKnF,OAAd,CAAuB,QAAvB,EAAmCkL,SAAhE,GACAD,iBAAiB,CAAC9F,UAAlB,CAA6B,eAAS,KAAKnF,OAAd,CAAuB,QAAvB,EAAmCkL,SAAhE,CADA,EAEAD,iBAAiB,CAAC9F,UAAlB,CAA6B,eAAS,KAAK1G,GAAd,CAAmB,QAAnB,EAA+ByM,SAA5D,CAFA,EAGAD,iBAAiB,CAAC9F,UAAlB,CAA6B,eAAS,KAAK1G,GAAd,CAAmB,QAAnB,EAA+ByM,SAA5D,CAJF,CAKE,CACA,MAAO,KAAP,CACD,CAED,MAAO,MAAP,CACD,CAzsB2C,C","sourcesContent":["import crypto from 'crypto'\nimport fs from 'fs'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { Worker } from 'jest-worker'\nimport AmpHtmlValidator from 'next/dist/compiled/amphtml-validator'\nimport findUp from 'next/dist/compiled/find-up'\nimport { join as pathJoin, relative, resolve as pathResolve, sep } from 'path'\nimport React from 'react'\nimport { UrlWithParsedQuery } from 'url'\nimport Watchpack from 'watchpack'\nimport { ampValidation } from '../build/output/index'\nimport * as Log from '../build/output/log'\nimport { PUBLIC_DIR_MIDDLEWARE_CONFLICT } from '../lib/constants'\nimport { fileExists } from '../lib/file-exists'\nimport { findPagesDir } from '../lib/find-pages-dir'\nimport loadCustomRoutes, { CustomRoutes } from '../lib/load-custom-routes'\nimport { verifyTypeScriptSetup } from '../lib/verifyTypeScriptSetup'\nimport {\n  PHASE_DEVELOPMENT_SERVER,\n  CLIENT_STATIC_FILES_PATH,\n  DEV_CLIENT_PAGES_MANIFEST,\n  STATIC_STATUS_PAGES,\n} from '../next-server/lib/constants'\nimport {\n  getRouteMatcher,\n  getRouteRegex,\n  getSortedRoutes,\n  isDynamicRoute,\n} from '../next-server/lib/router/utils'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport Server, { ServerConstructor } from '../next-server/server/next-server'\nimport { normalizePagePath } from '../next-server/server/normalize-page-path'\nimport Router, { Params, route } from '../next-server/server/router'\nimport { eventCliSession } from '../telemetry/events'\nimport { Telemetry } from '../telemetry/storage'\nimport { setGlobal } from '../telemetry/trace'\nimport HotReloader from './hot-reloader'\nimport { findPageFile } from './lib/find-page-file'\nimport { getNodeOptionsWithoutInspect } from './lib/utils'\nimport { withCoalescedInvoke } from '../lib/coalesced-function'\nimport { NextConfig } from '../next-server/server/config'\n\nif (typeof React.Suspense === 'undefined') {\n  throw new Error(\n    `The version of React you are using is lower than the minimum required version needed for Next.js. Please upgrade \"react\" and \"react-dom\": \"npm install react react-dom\" https://nextjs.org/docs/messages/invalid-react-version`\n  )\n}\n\n// Load ReactDevOverlay only when needed\nlet ReactDevOverlayImpl: React.FunctionComponent\nconst ReactDevOverlay = (props: any) => {\n  if (ReactDevOverlayImpl === undefined) {\n    ReactDevOverlayImpl = require('@next/react-dev-overlay/lib/client')\n      .ReactDevOverlay\n  }\n  return ReactDevOverlayImpl(props)\n}\n\nexport default class DevServer extends Server {\n  private devReady: Promise<void>\n  private setDevReady?: Function\n  private webpackWatcher?: Watchpack | null\n  private hotReloader?: HotReloader\n  private isCustomServer: boolean\n  protected sortedRoutes?: string[]\n\n  protected staticPathsWorker: import('jest-worker').Worker & {\n    loadStaticPaths: typeof import('./static-paths-worker').loadStaticPaths\n  }\n\n  constructor(\n    options: ServerConstructor & {\n      conf: NextConfig\n      isNextDevCommand?: boolean\n    }\n  ) {\n    super({ ...options, dev: true })\n    this.renderOpts.dev = true\n    ;(this.renderOpts as any).ErrorDebug = ReactDevOverlay\n    this.devReady = new Promise((resolve) => {\n      this.setDevReady = resolve\n    })\n    ;(this.renderOpts as any).ampSkipValidation =\n      this.nextConfig.experimental?.amp?.skipValidation ?? false\n    ;(this.renderOpts as any).ampValidator = (\n      html: string,\n      pathname: string\n    ) => {\n      const validatorPath =\n        this.nextConfig.experimental &&\n        this.nextConfig.experimental.amp &&\n        this.nextConfig.experimental.amp.validator\n      return AmpHtmlValidator.getInstance(validatorPath).then((validator) => {\n        const result = validator.validateString(html)\n        ampValidation(\n          pathname,\n          result.errors\n            .filter((e) => e.severity === 'ERROR')\n            .filter((e) => this._filterAmpDevelopmentScript(html, e)),\n          result.errors.filter((e) => e.severity !== 'ERROR')\n        )\n      })\n    }\n    if (fs.existsSync(pathJoin(this.dir, 'static'))) {\n      console.warn(\n        `The static directory has been deprecated in favor of the public directory. https://nextjs.org/docs/messages/static-dir-deprecated`\n      )\n    }\n    this.isCustomServer = !options.isNextDevCommand\n    this.pagesDir = findPagesDir(this.dir)\n    this.staticPathsWorker = new Worker(\n      require.resolve('./static-paths-worker'),\n      {\n        maxRetries: 1,\n        numWorkers: this.nextConfig.experimental.cpus,\n        forkOptions: {\n          env: {\n            ...process.env,\n            // discard --inspect/--inspect-brk flags from process.env.NODE_OPTIONS. Otherwise multiple Node.js debuggers\n            // would be started if user launch Next.js in debugging mode. The number of debuggers is linked to\n            // the number of workers Next.js tries to launch. The only worker users are interested in debugging\n            // is the main Next.js one\n            NODE_OPTIONS: getNodeOptionsWithoutInspect(),\n          },\n        },\n      }\n    ) as Worker & {\n      loadStaticPaths: typeof import('./static-paths-worker').loadStaticPaths\n    }\n\n    this.staticPathsWorker.getStdout().pipe(process.stdout)\n    this.staticPathsWorker.getStderr().pipe(process.stderr)\n  }\n\n  protected readBuildId(): string {\n    return 'development'\n  }\n\n  async addExportPathMapRoutes() {\n    // Makes `next export` exportPathMap work in development mode.\n    // So that the user doesn't have to define a custom server reading the exportPathMap\n    if (this.nextConfig.exportPathMap) {\n      console.log('Defining routes from exportPathMap')\n      const exportPathMap = await this.nextConfig.exportPathMap(\n        {},\n        {\n          dev: true,\n          dir: this.dir,\n          outDir: null,\n          distDir: this.distDir,\n          buildId: this.buildId,\n        }\n      ) // In development we can't give a default path mapping\n      for (const path in exportPathMap) {\n        const { page, query = {} } = exportPathMap[path]\n\n        // We use unshift so that we're sure the routes is defined before Next's default routes\n        this.router.addFsRoute({\n          match: route(path),\n          type: 'route',\n          name: `${path} exportpathmap route`,\n          fn: async (req, res, _params, parsedUrl) => {\n            const { query: urlQuery } = parsedUrl\n\n            Object.keys(urlQuery)\n              .filter((key) => query[key] === undefined)\n              .forEach((key) =>\n                console.warn(\n                  `Url '${path}' defines a query parameter '${key}' that is missing in exportPathMap`\n                )\n              )\n\n            const mergedQuery = { ...urlQuery, ...query }\n\n            await this.render(req, res, page, mergedQuery, parsedUrl)\n            return {\n              finished: true,\n            }\n          },\n        })\n      }\n    }\n  }\n\n  async startWatcher(): Promise<void> {\n    if (this.webpackWatcher) {\n      return\n    }\n\n    const regexPageExtension = new RegExp(\n      `\\\\.+(?:${this.nextConfig.pageExtensions.join('|')})$`\n    )\n\n    let resolved = false\n    return new Promise((resolve, reject) => {\n      const pagesDir = this.pagesDir\n\n      // Watchpack doesn't emit an event for an empty directory\n      fs.readdir(pagesDir!, (_, files) => {\n        if (files?.length) {\n          return\n        }\n\n        if (!resolved) {\n          resolve()\n          resolved = true\n        }\n      })\n\n      let wp = (this.webpackWatcher = new Watchpack())\n      wp.watch([], [pagesDir!], 0)\n\n      wp.on('aggregated', () => {\n        const routedPages = []\n        const knownFiles = wp.getTimeInfoEntries()\n        for (const [fileName, { accuracy }] of knownFiles) {\n          if (accuracy === undefined || !regexPageExtension.test(fileName)) {\n            continue\n          }\n\n          let pageName =\n            '/' + relative(pagesDir!, fileName).replace(/\\\\+/g, '/')\n          pageName = pageName.replace(regexPageExtension, '')\n          pageName = pageName.replace(/\\/index$/, '') || '/'\n\n          routedPages.push(pageName)\n        }\n\n        try {\n          // we serve a separate manifest with all pages for the client in\n          // dev mode so that we can match a page after a rewrite on the client\n          // before it has been built and is populated in the _buildManifest\n          const sortedRoutes = getSortedRoutes(routedPages)\n\n          if (\n            !this.sortedRoutes?.every((val, idx) => val === sortedRoutes[idx])\n          ) {\n            // emit the change so clients fetch the update\n            this.hotReloader!.send(undefined, { devPagesManifest: true })\n          }\n          this.sortedRoutes = sortedRoutes\n\n          this.dynamicRoutes = this.sortedRoutes\n            .filter(isDynamicRoute)\n            .map((page) => ({\n              page,\n              match: getRouteMatcher(getRouteRegex(page)),\n            }))\n\n          this.router.setDynamicRoutes(this.dynamicRoutes)\n\n          if (!resolved) {\n            resolve()\n            resolved = true\n          }\n        } catch (e) {\n          if (!resolved) {\n            reject(e)\n            resolved = true\n          } else {\n            console.warn('Failed to reload dynamic routes:', e)\n          }\n        }\n      })\n    })\n  }\n\n  async stopWatcher(): Promise<void> {\n    if (!this.webpackWatcher) {\n      return\n    }\n\n    this.webpackWatcher.close()\n    this.webpackWatcher = null\n  }\n\n  async prepare(): Promise<void> {\n    await verifyTypeScriptSetup(\n      this.dir,\n      this.pagesDir!,\n      false,\n      !this.nextConfig.images.disableStaticImages\n    )\n\n    this.customRoutes = await loadCustomRoutes(this.nextConfig)\n\n    // reload router\n    const { redirects, rewrites, headers } = this.customRoutes\n\n    if (\n      rewrites.beforeFiles.length ||\n      rewrites.afterFiles.length ||\n      rewrites.fallback.length ||\n      redirects.length ||\n      headers.length\n    ) {\n      this.router = new Router(this.generateRoutes())\n    }\n\n    this.hotReloader = new HotReloader(this.dir, {\n      pagesDir: this.pagesDir!,\n      config: this.nextConfig,\n      previewProps: this.getPreviewProps(),\n      buildId: this.buildId,\n      rewrites,\n    })\n    await super.prepare()\n    await this.addExportPathMapRoutes()\n    await this.hotReloader.start()\n    await this.startWatcher()\n    this.setDevReady!()\n\n    const telemetry = new Telemetry({ distDir: this.distDir })\n    telemetry.record(\n      eventCliSession(PHASE_DEVELOPMENT_SERVER, this.distDir, {\n        webpackVersion: this.hotReloader.isWebpack5 ? 5 : 4,\n        cliCommand: 'dev',\n        isSrcDir: relative(this.dir, this.pagesDir!).startsWith('src'),\n        hasNowJson: !!(await findUp('now.json', { cwd: this.dir })),\n        isCustomServer: this.isCustomServer,\n      })\n    )\n    // This is required by the tracing subsystem.\n    setGlobal('telemetry', telemetry)\n  }\n\n  protected async close(): Promise<void> {\n    await this.stopWatcher()\n    await this.staticPathsWorker.end()\n    if (this.hotReloader) {\n      await this.hotReloader.stop()\n    }\n  }\n\n  protected async hasPage(pathname: string): Promise<boolean> {\n    let normalizedPath: string\n\n    try {\n      normalizedPath = normalizePagePath(pathname)\n    } catch (err) {\n      console.error(err)\n      // if normalizing the page fails it means it isn't valid\n      // so it doesn't exist so don't throw and return false\n      // to ensure we return 404 instead of 500\n      return false\n    }\n\n    const pageFile = await findPageFile(\n      this.pagesDir!,\n      normalizedPath,\n      this.nextConfig.pageExtensions\n    )\n    return !!pageFile\n  }\n\n  protected async _beforeCatchAllRender(\n    req: IncomingMessage,\n    res: ServerResponse,\n    params: Params,\n    parsedUrl: UrlWithParsedQuery\n  ): Promise<boolean> {\n    const { pathname } = parsedUrl\n    const pathParts = params.path || []\n    const path = `/${pathParts.join('/')}`\n    // check for a public file, throwing error if there's a\n    // conflicting page\n    let decodedPath: string\n\n    try {\n      decodedPath = decodeURIComponent(path)\n    } catch (_) {\n      const err: Error & { code?: string } = new Error('failed to decode param')\n      err.code = 'DECODE_FAILED'\n      throw err\n    }\n\n    if (await this.hasPublicFile(decodedPath)) {\n      if (await this.hasPage(pathname!)) {\n        const err = new Error(\n          `A conflicting public file and page file was found for path ${pathname} https://nextjs.org/docs/messages/conflicting-public-file-page`\n        )\n        res.statusCode = 500\n        await this.renderError(err, req, res, pathname!, {})\n        return true\n      }\n      await this.servePublic(req, res, pathParts)\n      return true\n    }\n\n    return false\n  }\n\n  async run(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl: UrlWithParsedQuery\n  ): Promise<void> {\n    await this.devReady\n\n    const { basePath } = this.nextConfig\n    let originalPathname: string | null = null\n\n    if (basePath && parsedUrl.pathname?.startsWith(basePath)) {\n      // strip basePath before handling dev bundles\n      // If replace ends up replacing the full url it'll be `undefined`, meaning we have to default it to `/`\n      originalPathname = parsedUrl.pathname\n      parsedUrl.pathname = parsedUrl.pathname!.slice(basePath.length) || '/'\n    }\n\n    const { pathname } = parsedUrl\n\n    if (pathname!.startsWith('/_next')) {\n      if (await fileExists(pathJoin(this.publicDir, '_next'))) {\n        throw new Error(PUBLIC_DIR_MIDDLEWARE_CONFLICT)\n      }\n    }\n\n    const { finished = false } = await this.hotReloader!.run(\n      req,\n      res,\n      parsedUrl\n    )\n\n    if (finished) {\n      return\n    }\n\n    if (originalPathname) {\n      // restore the path before continuing so that custom-routes can accurately determine\n      // if they should match against the basePath or not\n      parsedUrl.pathname = originalPathname\n    }\n\n    return super.run(req, res, parsedUrl)\n  }\n\n  // override production loading of routes-manifest\n  protected getCustomRoutes(): CustomRoutes {\n    // actual routes will be loaded asynchronously during .prepare()\n    return {\n      redirects: [],\n      rewrites: { beforeFiles: [], afterFiles: [], fallback: [] },\n      headers: [],\n    }\n  }\n\n  private _devCachedPreviewProps: __ApiPreviewProps | undefined\n  protected getPreviewProps() {\n    if (this._devCachedPreviewProps) {\n      return this._devCachedPreviewProps\n    }\n    return (this._devCachedPreviewProps = {\n      previewModeId: crypto.randomBytes(16).toString('hex'),\n      previewModeSigningKey: crypto.randomBytes(32).toString('hex'),\n      previewModeEncryptionKey: crypto.randomBytes(32).toString('hex'),\n    })\n  }\n\n  generateRoutes() {\n    const { fsRoutes, ...otherRoutes } = super.generateRoutes()\n\n    // In development we expose all compiled files for react-error-overlay's line show feature\n    // We use unshift so that we're sure the routes is defined before Next's default routes\n    fsRoutes.unshift({\n      match: route('/_next/development/:path*'),\n      type: 'route',\n      name: '_next/development catchall',\n      fn: async (req, res, params) => {\n        const p = pathJoin(this.distDir, ...(params.path || []))\n        await this.serveStatic(req, res, p)\n        return {\n          finished: true,\n        }\n      },\n    })\n\n    fsRoutes.unshift({\n      match: route(\n        `/_next/${CLIENT_STATIC_FILES_PATH}/${this.buildId}/${DEV_CLIENT_PAGES_MANIFEST}`\n      ),\n      type: 'route',\n      name: `_next/${CLIENT_STATIC_FILES_PATH}/${this.buildId}/${DEV_CLIENT_PAGES_MANIFEST}`,\n      fn: async (_req, res) => {\n        res.statusCode = 200\n        res.setHeader('Content-Type', 'application/json; charset=utf-8')\n        res.end(\n          JSON.stringify({\n            pages: this.sortedRoutes,\n          })\n        )\n        return {\n          finished: true,\n        }\n      },\n    })\n\n    fsRoutes.push({\n      match: route('/:path*'),\n      type: 'route',\n      requireBasePath: false,\n      name: 'catchall public directory route',\n      fn: async (req, res, params, parsedUrl) => {\n        const { pathname } = parsedUrl\n        if (!pathname) {\n          throw new Error('pathname is undefined')\n        }\n\n        // Used in development to check public directory paths\n        if (await this._beforeCatchAllRender(req, res, params, parsedUrl)) {\n          return {\n            finished: true,\n          }\n        }\n\n        return {\n          finished: false,\n        }\n      },\n    })\n\n    return { fsRoutes, ...otherRoutes }\n  }\n\n  // In development public files are not added to the router but handled as a fallback instead\n  protected generatePublicRoutes(): never[] {\n    return []\n  }\n\n  // In development dynamic routes cannot be known ahead of time\n  protected getDynamicRoutes(): never[] {\n    return []\n  }\n\n  _filterAmpDevelopmentScript(\n    html: string,\n    event: { line: number; col: number; code: string }\n  ): boolean {\n    if (event.code !== 'DISALLOWED_SCRIPT_TAG') {\n      return true\n    }\n\n    const snippetChunks = html.split('\\n')\n\n    let snippet\n    if (\n      !(snippet = html.split('\\n')[event.line - 1]) ||\n      !(snippet = snippet.substring(event.col))\n    ) {\n      return true\n    }\n\n    snippet = snippet + snippetChunks.slice(event.line).join('\\n')\n    snippet = snippet.substring(0, snippet.indexOf('</script>'))\n\n    return !snippet.includes('data-amp-development-mode-only')\n  }\n\n  protected async getStaticPaths(\n    pathname: string\n  ): Promise<{\n    staticPaths: string[] | undefined\n    fallbackMode: false | 'static' | 'blocking'\n  }> {\n    // we lazy load the staticPaths to prevent the user\n    // from waiting on them for the page to load in dev mode\n\n    const __getStaticPaths = async () => {\n      const { publicRuntimeConfig, serverRuntimeConfig } = this.nextConfig\n      const { locales, defaultLocale } = this.nextConfig.i18n || {}\n\n      const paths = await this.staticPathsWorker.loadStaticPaths(\n        this.distDir,\n        pathname,\n        !this.renderOpts.dev && this._isLikeServerless,\n        {\n          publicRuntimeConfig,\n          serverRuntimeConfig,\n        },\n        locales,\n        defaultLocale\n      )\n      return paths\n    }\n    const { paths: staticPaths, fallback } = (\n      await withCoalescedInvoke(__getStaticPaths)(`staticPaths-${pathname}`, [])\n    ).value\n\n    return {\n      staticPaths,\n      fallbackMode:\n        fallback === 'blocking'\n          ? 'blocking'\n          : fallback === true\n          ? 'static'\n          : false,\n    }\n  }\n\n  protected async ensureApiPage(pathname: string) {\n    return this.hotReloader!.ensurePage(pathname)\n  }\n\n  async renderToHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: { [key: string]: string }\n  ): Promise<string | null> {\n    await this.devReady\n    const compilationErr = await this.getCompilationError(pathname)\n    if (compilationErr) {\n      res.statusCode = 500\n      return this.renderErrorToHTML(compilationErr, req, res, pathname, query)\n    }\n\n    // In dev mode we use on demand entries to compile the page before rendering\n    try {\n      await this.hotReloader!.ensurePage(pathname).catch(async (err: Error) => {\n        if ((err as any).code !== 'ENOENT') {\n          throw err\n        }\n\n        for (const dynamicRoute of this.dynamicRoutes || []) {\n          const params = dynamicRoute.match(pathname)\n          if (!params) {\n            continue\n          }\n\n          return this.hotReloader!.ensurePage(dynamicRoute.page)\n        }\n        throw err\n      })\n    } catch (err) {\n      if (err.code === 'ENOENT') {\n        try {\n          await this.hotReloader!.ensurePage('/404')\n        } catch (hotReloaderError) {\n          if (hotReloaderError.code !== 'ENOENT') {\n            throw hotReloaderError\n          }\n        }\n\n        res.statusCode = 404\n        return this.renderErrorToHTML(null, req, res, pathname, query)\n      }\n      if (!this.quiet) console.error(err)\n    }\n    const html = await super.renderToHTML(req, res, pathname, query)\n    return html\n  }\n\n  async renderErrorToHTML(\n    err: Error | null,\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: { [key: string]: string }\n  ): Promise<string | null> {\n    await this.devReady\n    if (res.statusCode === 404 && (await this.hasPage('/404'))) {\n      await this.hotReloader!.ensurePage('/404')\n    } else if (\n      STATIC_STATUS_PAGES.includes(`/${res.statusCode}`) &&\n      (await this.hasPage(`/${res.statusCode}`))\n    ) {\n      await this.hotReloader!.ensurePage(`/${res.statusCode}`)\n    } else {\n      await this.hotReloader!.ensurePage('/_error')\n    }\n\n    const compilationErr = await this.getCompilationError(pathname)\n    if (compilationErr) {\n      res.statusCode = 500\n      return super.renderErrorToHTML(compilationErr, req, res, pathname, query)\n    }\n\n    if (!err && res.statusCode === 500) {\n      err = new Error(\n        'An undefined error was thrown sometime during render... ' +\n          'See https://nextjs.org/docs/messages/threw-undefined'\n      )\n    }\n\n    try {\n      const out = await super.renderErrorToHTML(err, req, res, pathname, query)\n      return out\n    } catch (err2) {\n      if (!this.quiet) Log.error(err2)\n      res.statusCode = 500\n      return super.renderErrorToHTML(err2, req, res, pathname, query)\n    }\n  }\n\n  sendHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    html: string\n  ): Promise<void> {\n    // In dev, we should not cache pages for any reason.\n    res.setHeader('Cache-Control', 'no-store, must-revalidate')\n    return super.sendHTML(req, res, html)\n  }\n\n  protected setImmutableAssetCacheControl(res: ServerResponse): void {\n    res.setHeader('Cache-Control', 'no-store, must-revalidate')\n  }\n\n  private servePublic(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathParts: string[]\n  ): Promise<void> {\n    const p = pathJoin(this.publicDir, ...pathParts)\n    return this.serveStatic(req, res, p)\n  }\n\n  async hasPublicFile(path: string): Promise<boolean> {\n    try {\n      const info = await fs.promises.stat(pathJoin(this.publicDir, path))\n      return info.isFile()\n    } catch (_) {\n      return false\n    }\n  }\n\n  async getCompilationError(page: string): Promise<any> {\n    const errors = await this.hotReloader!.getCompilationErrors(page)\n    if (errors.length === 0) return\n\n    // Return the very first error we found.\n    return errors[0]\n  }\n\n  protected isServeableUrl(untrustedFileUrl: string): boolean {\n    // This method mimics what the version of `send` we use does:\n    // 1. decodeURIComponent:\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L989\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L518-L522\n    // 2. resolve:\n    //    https://github.com/pillarjs/send/blob/de073ed3237ade9ff71c61673a34474b30e5d45b/index.js#L561\n\n    let decodedUntrustedFilePath: string\n    try {\n      // (1) Decode the URL so we have the proper file name\n      decodedUntrustedFilePath = decodeURIComponent(untrustedFileUrl)\n    } catch {\n      return false\n    }\n\n    // (2) Resolve \"up paths\" to determine real request\n    const untrustedFilePath = pathResolve(decodedUntrustedFilePath)\n\n    // don't allow null bytes anywhere in the file path\n    if (untrustedFilePath.indexOf('\\0') !== -1) {\n      return false\n    }\n\n    // During development mode, files can be added while the server is running.\n    // Checks for .next/static, .next/server, static and public.\n    // Note that in development .next/server is available for error reporting purposes.\n    // see `packages/next/next-server/server/next-server.ts` for more details.\n    if (\n      untrustedFilePath.startsWith(pathJoin(this.distDir, 'static') + sep) ||\n      untrustedFilePath.startsWith(pathJoin(this.distDir, 'server') + sep) ||\n      untrustedFilePath.startsWith(pathJoin(this.dir, 'static') + sep) ||\n      untrustedFilePath.startsWith(pathJoin(this.dir, 'public') + sep)\n    ) {\n      return true\n    }\n\n    return false\n  }\n}\n"]}